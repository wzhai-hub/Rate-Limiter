下面是针对这 3 个用户 API (`api1`, `api2`, `api3`) 的设计文档模板，包括详细说明、数据流、和测试目标。这些 API 的主要功能是受限于流量控制，同时返回模拟的响应。

---

### **用户 API 设计文档**

#### 1. **文档结构**
1. **API 概述**
2. **接口设计**
3. **功能描述**
4. **流量控制规则**
5. **测试计划**
6. **扩展性建议**

---

### **1. API 概述**
- **API 名称**: 用户数据获取 API
- **目标用户**: 系统用户（user1、user2、user3 等）
- **用途**: 模拟高并发访问，验证流量控制逻辑是否生效。

---

### **2. 接口设计**
#### API 1: 获取用户基本信息
- **HTTP 方法**: GET
- **URL**: `/api1`
- **请求参数**:
    - `userId` (必填): 用户唯一标识。
- **响应**:
    - 成功响应:
      ```json
      {
        "userId": "user1",
        "info": "Basic information"
      }
      ```
    - 限流响应:
      ```json
      {
        "error": "Rate Limit Exceeded",
        "message": "You have exceeded the allowed requests per minute."
      }
      ```

#### API 2: 获取用户活动信息
- **HTTP 方法**: GET
- **URL**: `/api2`
- **请求参数**:
    - `userId` (必填): 用户唯一标识。
- **响应**:
    - 成功响应:
      ```json
      {
        "userId": "user1",
        "activity": "Last login: 2024-12-01"
      }
      ```
    - 限流响应:
      ```json
      {
        "error": "Rate Limit Exceeded",
        "message": "You have exceeded the allowed requests per minute."
      }
      ```

#### API 3: 获取用户偏好设置
- **HTTP 方法**: GET
- **URL**: `/api3`
- **请求参数**:
    - `userId` (必填): 用户唯一标识。
- **响应**:
    - 成功响应:
      ```json
      {
        "userId": "user1",
        "preferences": "Theme: Dark mode"
      }
      ```
    - 限流响应:
      ```json
      {
        "error": "Rate Limit Exceeded",
        "message": "You have exceeded the allowed requests per minute."
      }
      ```

---

### **3. 功能描述**
- **API 功能**:
    1. 接收 GET 请求，根据 `userId` 返回指定用户的数据。
    2. 调用限流服务，检查用户的请求频率是否超限。
    3. 在请求超限的情况下，返回 429 状态码和限流错误信息。

---

### **4. 流量控制规则**
| **用户** | **最大请求数/分钟** | **API** |
|----------|---------------------|---------|
| user1    | 10000               | api1, api2, api3 |
| user2    | 8000                | api1, api2, api3 |
| user3    | 5000                | api1, api2, api3 |

- **策略说明**:
    - 流量控制基于 Redis 实现，每分钟的请求次数存储在 Redis 的计数器中。
    - 若用户在 1 分钟内累计请求次数超过限制，则触发限流逻辑。

---

### **5. 测试计划**
#### 测试目标
1. **验证限流逻辑**: 确保超出限流阈值时返回错误响应。
2. **验证高并发性能**: 在高并发场景下，限流逻辑是否稳定、性能是否满足需求。
3. **验证响应时间**: 确保限流逻辑的响应时间不会对正常请求产生明显影响。

#### 测试用例
| **用例编号** | **测试场景**                                   | **预期结果** |
|--------------|-----------------------------------------------|--------------|
| TC01         | 单用户请求未超出限流阈值                       | 正常响应     |
| TC02         | 单用户请求超出限流阈值（10001 次/分钟）        | 返回限流错误 |
| TC03         | 多用户请求，全部用户均未超出限流阈值           | 正常响应     |
| TC04         | 多用户请求，部分用户超出限流阈值               | 超限用户返回限流错误，其余正常响应 |
| TC05         | 1000 并发线程模拟高并发请求，检查系统性能       | 响应时间 < 200 ms |

#### 测试工具
- 使用 **Spring Boot Test** 编写测试用例。
- 使用 **ThreadPoolExecutor** 模拟多线程高并发。

---

### **6. 扩展性建议**
1. **分布式部署**: 将 Redis 部署为集群以支持更高的请求量。
2. **动态限流规则**: 提供后台管理界面，动态调整每个用户的限流规则。
3. **实时分析**: 集成 Kafka，用于异步分析请求数据，支持更复杂的限流策略（如滑动窗口）。

---

按照这个文档格式撰写，可以清晰展示每个 API 的功能和限流逻辑，同时为后续扩展和测试提供支持。